#!/usr/bin/env python
# -*- coding: utf-8 -*-
import collections, os, re, string, sys

if len(sys.argv) != 2:
  print "usage: " + sys.argv[0] + " <sbt_bench_stdout>"
  sys.exit(1)

sbt_bench_stdout = ""
with open(sys.argv[1], "r") as sbt_bench_stdout_file:
  sbt_bench_stdout = sbt_bench_stdout_file.read()

results_section_template = string.Template("""
## Results

To reproduce, run `sbt bench` (this will take a while).

<table>
  <th>
    <td>Cold</td>
    <td>Hot</td>
  </th>
  <tr>
    <td width="208px">RscNativeSchedule</td>
    <td width="208px">$ColdRscNativeSchedule</td>
    <td width="208px">$HotRscNativeSchedule</td>
  </tr>
  <tr>
    <td>RscSchedule</td>
    <td>$ColdRscSchedule</td>
    <td>$HotRscSchedule</td>
  </tr>
  <tr>
    <td>ScalacNamer211</td>
    <td>1179.715 ± 2.818 ms</td>
    <td>62.111 ± 0.099 ms</td>
  </tr>
  <tr>
    <td>ScalacNamer212</td>
    <td>1642.299 ± 2.927 ms</td>
    <td>27.683 ± 0.029 ms</td>
  </tr>
</table>

<table>
  <th>
    <td>Cold</td>
    <td>Hot</td>
  </th>
  <tr>
    <td width="208px">RscNativeTypecheck</td>
    <td width="208px">$ColdRscNativeTypecheck</td>
    <td width="208px">$HotRscNativeTypecheck</td>
  </tr>
  <tr>
    <td>RscTypecheck</td>
    <td>$ColdRscTypecheck</td>
    <td>$HotRscTypecheck</td>
  </tr>
  <tr>
    <td>ScalacTyper211</td>
    <td>4295.242 ± 24.084 ms</td>
    <td>707.156 ± 1.441 ms</td>
  </tr>
  <tr>
    <td>ScalacTyper212</td>
    <td>5167.287 ± 24.531 ms</td>
    <td>610.896 ± 1.594 ms</td>
  </tr>
</table>

<table>
  <th>
    <td>Cold</td>
    <td>Hot</td>
  </th>
  <tr>
    <td width="208px">ScalacCompile211</td>
    <td width="208px">8047.402 ± 43.037 ms</td>
    <td width="208px">1702.511 ± 10.349 ms</td>
  </tr>
  <tr>
    <td>ScalacCompile212</td>
    <td>9456.717 ± 45.414 ms</td>
    <td>1630.761 ± 10.607 ms</td>
  </tr>
  <tr>
    <td>JavacCompile</td>
    <td>801.029 ± 4.258 ms</td>
    <td>73.772 ± 0.153 ms</td>
  </tr>
</table>
""")

results_keys = re.findall("\$(\w+)", results_section_template.template)
results_dict = {}
for results_key in results_keys:
  m = re.search(results_key + "\.run\s+\w+\s+\d+(.*?)ms/op", sbt_bench_stdout)
  results_value = m.groups()[0].strip() + " ms" if m else "N/A"
  results_value = results_value.replace("  ", " ")
  results_dict[results_key] = results_value

results_dict = collections.defaultdict(lambda: "N/A", results_dict)
results_section = results_section_template.substitute(results_dict)

repo_root = os.path.dirname(os.path.dirname(os.path.abspath(sys.argv[0])))
performance_md_path = os.path.join(repo_root, "docs", "performance.md")
performance_md_lines = []
with open(performance_md_path, "r") as performance_md_file:
  skip_section = False
  for line in performance_md_file:
    if skip_section and not line.startswith("#"):
      pass
    else:
      skip_section = False
      if line == "## Results\n":
        skip_section = True
        performance_md_lines.append(results_section.strip() + "\n")
      else:
        performance_md_lines.append(line)

with open(performance_md_path, "w") as performance_md_file:
  for line in performance_md_lines:
    performance_md_file.write(line)
